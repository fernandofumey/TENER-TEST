<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish 2: Tener & Idioms Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- Navbar -->
    <nav class="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold uppercase tracking-wider">Verbo Tener Exam</h1>
                <p class="text-xs text-indigo-200">Worksheet Mastery • 50 Questions</p>
            </div>
            <button onclick="toggleTeacherModal()" class="text-xs bg-indigo-800 hover:bg-indigo-700 px-3 py-1 rounded transition cursor-pointer border border-indigo-600">
                <i class="fas fa-lock mr-1"></i> Teacher Access
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-6">
        
        <!-- Student Login Form -->
        <div id="student-login" class="bg-white p-8 rounded-xl shadow-lg fade-in border-t-4 border-indigo-600">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Student Identification</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2">First Name</label>
                    <input type="text" id="fname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter your first name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Last Name</label>
                    <input type="text" id="lname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter your last name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Period</label>
                    <select id="period" class="w-full p-3 border rounded-lg bg-white">
                        <option>1st</option>
                        <option>A2</option>
                        <option>A4</option>
                        <option>B3</option>
                        <option>B4</option>
                        <option>5th</option>
                    </select>
                </div>
            </div>
            <button onclick="startQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.01] shadow-md">
                Start Exam
            </button>
        </div>

        <!-- Quiz Container (Hidden initially) -->
        <div id="quiz-container" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex justify-between items-center">
                    <span id="student-display" class="font-semibold text-indigo-800"></span>
                    <span class="text-sm text-gray-500 font-mono bg-indigo-100 px-2 py-1 rounded">50 Questions (Randomized)</span>
                </div>
                <div id="questions-list" class="p-6 space-y-8">
                    <!-- Questions injected via JS -->
                </div>
                <div class="p-6 bg-gray-50 border-t flex justify-center">
                    <button onclick="submitExam()" class="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:-translate-y-1">
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Section (Hidden initially) -->
        <div id="result-container" class="hidden-section fade-in text-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-3xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Exam Completed!</h2>
                <p class="text-gray-600 mb-6">Your score has been recorded.</p>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-8">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Final Score</p>
                    <p id="final-score-display" class="text-5xl font-bold text-indigo-900 mt-2">0%</p>
                </div>

                <!-- High Visibility Warning -->
                <div class="bg-red-600 border-4 border-red-800 p-6 rounded-xl text-center text-white mb-8 shadow-2xl">
                    <i class="fas fa-file-download text-5xl mb-4 text-yellow-300 animate-bounce"></i>
                    <h3 class="text-2xl font-black uppercase mb-4 tracking-wide border-b-2 border-red-400 pb-2">⚠ ACTION REQUIRED ⚠</h3>
                    <p class="text-xl font-bold leading-tight mb-2">
                        DOWNLOAD THE FILE AND SEND IT TO YOUR TEACHER!!!
                    </p>
                    <p class="text-lg">
                        Look for <code id="filename-display" class="bg-white text-red-600 px-2 py-1 rounded font-mono font-bold mx-1 text-base">result.csv</code> in your downloads folder.
                    </p>
                </div>

                <!-- Manual Download Button -->
                <div class="mb-6">
                    <p class="text-sm text-gray-500 mb-2">Did the file not download automatically?</p>
                    <button onclick="downloadResult(lastResultData)" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition flex items-center justify-center mx-auto gap-2">
                        <i class="fas fa-download"></i> Download File Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard (Hidden) -->
        <div id="teacher-dashboard" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border-t-4 border-purple-600">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chalkboard-teacher text-purple-600 mr-2"></i>Teacher Dashboard</h2>
                    <button onclick="logoutTeacher()" class="text-red-500 hover:text-red-700 font-medium">Logout</button>
                </div>

                <!-- Data Import -->
                <div class="bg-indigo-50 border-2 border-dashed border-indigo-300 rounded-xl p-8 text-center mb-8 hover:bg-indigo-100 transition cursor-pointer" ondragover="event.preventDefault()" ondrop="handleDrop(event)" onclick="document.getElementById('file-upload').click()">
                    <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-3"></i>
                    <p class="font-semibold text-indigo-900">Upload Student Results</p>
                    <p class="text-sm text-indigo-600 mb-4">Drag & drop student <strong>.csv</strong> files here or click to select</p>
                    <input type="file" id="file-upload" multiple class="hidden" onchange="handleFiles(this.files)" accept=".csv">
                    <button class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition pointer-events-none">Select Files</button>
                </div>

                <!-- Statistics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Total Students</p>
                        <p id="stat-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Average Score</p>
                        <p id="stat-avg" class="text-3xl font-bold text-indigo-600">0%</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Highest Score</p>
                        <p id="stat-high" class="text-3xl font-bold text-green-600">0%</p>
                    </div>
                </div>

                <!-- Top 3 Missed -->
                <div class="bg-red-50 rounded-xl p-6 mb-8 border border-red-100">
                    <h3 class="text-lg font-bold text-red-800 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Top 3 Most Missed Questions</h3>
                    <div id="missed-questions-list" class="space-y-3">
                        <p class="text-gray-500 italic">Upload data to see insights.</p>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-semibold text-gray-600">Name</th>
                                <th class="p-4 font-semibold text-gray-600">Period</th>
                                <th class="p-4 font-semibold text-gray-600">Score</th>
                                <th class="p-4 font-semibold text-gray-600">Missed Q#</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Rows injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-96 transform transition-all scale-100">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-key text-indigo-600"></i> Teacher Access</h3>
            <input type="password" id="teacher-pwd" class="w-full border p-3 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter Password" onkeydown="if(event.key === 'Enter') verifyTeacher()">
            <p id="pwd-error" class="text-red-500 text-sm mb-4 hidden bg-red-50 p-2 rounded border border-red-100"><i class="fas fa-times-circle"></i> Incorrect password</p>
            <div class="flex justify-end gap-2">
                <button onclick="toggleTeacherModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">Cancel</button>
                <button onclick="verifyTeacher()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow">Login</button>
            </div>
        </div>
    </div>

<script>
// --- Configuration ---
const TEACHER_PASSWORD = "admin"; // CHANGE THIS PASSWORD

// --- 50 Questions Data ---
// Note: 'a' is the index of the correct answer in the 'options' array.
const quizData = [
    // Section 1: Conjugation of Tener (1-10)
    { q: "Yo ___ un hermano.", options: ["tengo", "tiene", "tienes", "tienen"], a: 0 },
    { q: "Tú ___ dos perros.", options: ["tengo", "tiene", "tienes", "tienen"], a: 2 },
    { q: "Ella ___ una clase de arte.", options: ["tiene", "tienen", "tienes", "tengo"], a: 0 },
    { q: "Nosotros ___ mucha tarea.", options: ["tienen", "tenéis", "tenemos", "tengo"], a: 2 },
    { q: "Ustedes ___ los libros.", options: ["tenemos", "tienen", "tiene", "tienes"], a: 1 },
    { q: "Ellos ___ una casa grande.", options: ["tiene", "tienen", "tienes", "tengo"], a: 1 },
    { q: "Usted ___ el dinero.", options: ["tienes", "tengo", "tiene", "tienen"], a: 2 },
    { q: "Mis amigos ___ bicicletas.", options: ["tienen", "tiene", "tenemos", "tengo"], a: 0 },
    { q: "Juan y yo ___ cuadernos.", options: ["tienen", "tenéis", "tenemos", "tiene"], a: 2 },
    { q: "La chica ___ un examen.", options: ["tienes", "tienen", "tengo", "tiene"], a: 3 },

    // Section 2: Tener Que vs. Hay Que (11-20)
    { q: "___ estudiar para aprender.", options: ["Tengo que", "Hay que"], a: 1 },
    { q: "Yo ___ ir al baño.", options: ["tengo que", "hay que"], a: 0 },
    { q: "___ limpiar la cocina.", options: ["Tiene que", "Hay que"], a: 1 },
    { q: "Nosotros ___ comer verduras.", options: ["hay que", "tenemos que"], a: 1 },
    { q: "Para vivir, ___ beber agua.", options: ["hay que", "tienen que"], a: 0 },
    { q: "Tú ___ escuchar al profesor.", options: ["tienes que", "hay que"], a: 0 },
    { q: "___ respetar a los otros.", options: ["Hay que", "Tiene que"], a: 0 },
    { q: "Ellas ___ comprar zapatos.", options: ["tienen que", "hay que"], a: 0 },
    { q: "En la biblioteca, ___ guardar silencio.", options: ["hay que", "tenemos que"], a: 0 },
    { q: "Usted ___ firmar el documento.", options: ["hay que", "tiene que"], a: 1 },

    // Section 3: Vocabulary - Idioms (21-30)
    { q: "Translate: Tener sed", options: ["To be thirsty", "To be hungry", "To be sleepy", "To be cold"], a: 0 },
    { q: "Translate: Tener calor", options: ["To be cold", "To be hot", "To be afraid", "To be correct"], a: 1 },
    { q: "Translate: Tener frío", options: ["To be hot", "To be cold", "To be lucky", "To be careful"], a: 1 },
    { q: "Translate: Tener suerte", options: ["To be lucky", "To be sleepy", "To be right", "To be hungry"], a: 0 },
    { q: "Translate: Tener cuidado", options: ["To be afraid", "To be careful", "To be in a hurry", "To be correct"], a: 1 },
    { q: "Translate: Tener razón", options: ["To be wrong", "To be right/correct", "To be thirsty", "To be cold"], a: 1 },
    { q: "Translate: Tener miedo", options: ["To be lucky", "To be hot", "To be afraid", "To have years"], a: 2 },
    { q: "Translate: Tener hambre", options: ["To be hungry", "To be thirsty", "To be sleepy", "To be careful"], a: 0 },
    { q: "Translate: Tener 15 años", options: ["To be 15 years old", "To have 15 brothers", "To be lucky", "To have 15 dogs"], a: 0 },
    { q: "Translate: Tener sueño", options: ["To be thirsty", "To be right", "To be sleepy", "To be afraid"], a: 2 },

    // Section 4: Logical Completion (31-40)
    { q: "I haven't eaten all day.", options: ["Tengo miedo", "Tengo hambre", "Tengo prisa", "Tengo razón"], a: 1 },
    { q: "It is 100 degrees outside (Fahrenheit).", options: ["Tengo calor", "Tengo frío", "Tengo razón", "Tengo suerte"], a: 0 },
    { q: "I am walking alone in a haunted house.", options: ["Tengo suerte", "Tengo sueño", "Tengo miedo", "Tengo sed"], a: 2 },
    { q: "The class starts in 1 minute and I am far away.", options: ["Tengo prisa", "Tengo hambre", "Tengo sed", "Tengo calor"], a: 0 },
    { q: "It is snowing and I forgot my coat.", options: ["Tengo calor", "Tengo frío", "Tengo años", "Tengo razón"], a: 1 },
    { q: "I stayed up all night studying.", options: ["Tengo suerte", "Tengo sueño", "Tengo hambre", "Tengo miedo"], a: 1 },
    { q: "The teacher asked 'What is 2+2?' and I said '4'.", options: ["Tengo razón", "Tengo sed", "Tengo miedo", "Tengo frío"], a: 0 },
    { q: "I won the lottery!", options: ["Tengo suerte", "Tengo cuidado", "Tengo frío", "Tengo sueño"], a: 0 },
    { q: "You are running with scissors. Mom says: '¡___!'", options: ["Ten prisa", "Ten cuidado", "Ten suerte", "Ten hambre"], a: 1 },
    { q: "My throat is dry. I need water.", options: ["Tengo sed", "Tengo hambre", "Tengo sueño", "Tengo calor"], a: 0 },

    // Section 5: Grammar & Translation (41-50)
    { q: "Translate: 'I am hungry' = Yo ___ hambre.", options: ["tengo", "tiene", "eres", "estoy"], a: 0 },
    { q: "Translate: 'She has to eat' = Ella tiene ___ comer.", options: ["de", "que", "a", "en"], a: 1 },
    { q: "Translate: 'We are cold' = Nosotros ___ frío.", options: ["estamos", "somos", "tenemos", "tienen"], a: 2 },
    { q: "Grammar: To say 'One must listen,' you use ___ que escuchar.", options: ["Tiene", "Hay", "Tengo", "Es"], a: 1 },
    { q: "Grammar: The 'yo' form of Tener is...", options: ["Tenero", "Tieno", "Tengo", "Tenga"], a: 2 },
    { q: "Grammar: Tener expressions use nouns (like 'hunger'), not adjectives (True/False)?", options: ["True (Cierto)", "False (Falso)"], a: 0 },
    { q: "Translate: 'They are sleepy' = Ellos ___ sueño.", options: ["tienen", "son", "están", "tenemos"], a: 0 },
    { q: "Translate: 'You (informal) are right' = Tú ___ razón.", options: ["tienes", "eres", "estás", "tiene"], a: 0 },
    { q: "Logic: If you make a mistake, you do NOT have...", options: ["suerte", "razón", "frío", "sed"], a: 1 },
    { q: "Translate: 'I have to go' = Yo tengo ___ ir.", options: ["que", "a", "de", "en"], a: 0 }
];

let studentData = {
    fname: "",
    lname: "",
    period: "",
    answers: [] 
};

let lastResultData = null;
let currentSessionQuiz = []; // Holds the randomized quiz for the current student

// --- Utility: Fisher-Yates Shuffle ---
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// --- Student Flow ---

function startQuiz() {
    const f = document.getElementById('fname').value.trim();
    const l = document.getElementById('lname').value.trim();
    const p = document.getElementById('period').value;

    if (!f || !l) {
        alert("Please enter your full name.");
        return;
    }

    studentData.fname = f;
    studentData.lname = l;
    studentData.period = p;

    // --- RANDOMIZATION LOGIC ---
    // 1. Create a deep copy of quizData including original IDs
    currentSessionQuiz = quizData.map((item, index) => ({
        ...item,
        originalIndex: index, // Track original Question ID for Teacher Dashboard
        options: [...item.options] // Copy options array
    }));

    // 2. Shuffle Questions order
    shuffleArray(currentSessionQuiz);

    // 3. Shuffle Options within each question
    currentSessionQuiz.forEach(q => {
        // Store the correct answer text(s) before shuffling
        let correctTexts = [];
        if (Array.isArray(q.a)) {
            correctTexts = q.a.map(idx => quizData[q.originalIndex].options[idx]); // Use original options to get text
        } else {
            correctTexts = [quizData[q.originalIndex].options[q.a]];
        }

        // Shuffle the options array
        shuffleArray(q.options);

        // Find the new index/indices of the correct answer(s)
        if (Array.isArray(q.a)) {
            q.a = correctTexts.map(text => q.options.indexOf(text));
        } else {
            q.a = q.options.indexOf(correctTexts[0]);
        }
    });

    document.getElementById('student-display').innerText = `${l}, ${f} (${p})`;
    document.getElementById('student-login').classList.add('hidden-section');
    document.getElementById('quiz-container').classList.remove('hidden-section');

    renderQuestions();
    window.scrollTo(0, 0);
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    container.innerHTML = currentSessionQuiz.map((q, index) => `
        <div class="mb-6 p-5 border border-gray-200 rounded-xl hover:shadow-md transition bg-gray-50" id="q-box-${index}">
            <div class="flex items-start gap-3">
                <span class="bg-indigo-100 text-indigo-800 font-bold px-3 py-1 rounded text-sm h-fit mt-1">${index + 1}</span>
                <div class="w-full">
                    <p class="font-semibold text-lg mb-4 text-gray-800">${q.q}</p>
                    
                    <div class="space-y-3 mb-4">
                        ${q.options.map((opt, optIndex) => `
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg border border-transparent hover:bg-indigo-100 hover:border-indigo-300 transition group">
                                <input type="radio" name="q${index}" value="${optIndex}" class="form-radio h-5 w-5 text-indigo-600 focus:ring-indigo-500">
                                <span class="group-hover:text-indigo-900">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function submitExam() {
    const answers = [];
    let totalPoints = 0; // Out of 100 (Each Q worth 2pts)
    let missedIndices = []; // Stores ORIGINAL INDICES for Teacher Dashboard

    for (let i = 0; i < currentSessionQuiz.length; i++) {
        // 1. Check Multiple Choice
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        
        // Validation: Did they answer?
        if (!selected) {
            alert(`You missed Question ${i + 1}. Please answer all questions before submitting.`);
            document.getElementById(`q-box-${i}`).scrollIntoView({behavior: "smooth", block: "center"});
            document.getElementById(`q-box-${i}`).classList.add('border-red-500', 'bg-red-50');
            setTimeout(() => document.getElementById(`q-box-${i}`).classList.remove('border-red-500', 'bg-red-50'), 2000);
            return;
        }

        const val = parseInt(selected.value);
        answers.push(val);
        
        // Get current question object
        const currentQ = currentSessionQuiz[i];

        // Check MCQ
        let mcqCorrect = false;
        if (Array.isArray(currentQ.a)) {
            // Question 19 has multiple correct answers, check if selected index is in valid array
            mcqCorrect = currentQ.a.includes(val);
        } else {
            mcqCorrect = (val === currentQ.a);
        }

        // Scoring: 2 points per question
        if (mcqCorrect) {
            totalPoints += 2;
        } else {
            // Push the ORIGINAL ID to missedIndices so the dashboard knows which question content was missed
            missedIndices.push(currentQ.originalIndex);
        }
    }

    const finalScore = totalPoints; // Max score is 100 (50 questions * 2 points)
    
    const resultPayload = {
        name: `${studentData.lname}, ${studentData.fname}`,
        period: studentData.period,
        score: finalScore,
        rawScore: totalPoints,
        total: quizData.length,
        missed: missedIndices, // These are Canonical IDs (0-49)
        timestamp: new Date().toISOString()
    };

    lastResultData = resultPayload;

    document.getElementById('quiz-container').classList.add('hidden-section');
    document.getElementById('result-container').classList.remove('hidden-section');
    document.getElementById('final-score-display').innerText = finalScore + "%";
    window.scrollTo(0, 0);
    
    downloadResult(resultPayload);
}

function downloadResult(data) {
    if (!data) return;
    
    const headers = ["Name", "Period", "Score", "RawScore", "Total", "Timestamp", "MissedQuestionIndices"];
    const safeName = data.name.replace(/"/g, '""');
    const missedStr = data.missed.join('|');
    
    const row = [
        `"${safeName}"`,
        `"${data.period}"`,
        data.score,
        data.rawScore,
        data.total,
        `"${data.timestamp}"`,
        `"${missedStr}"`
    ];
    
    const csvContent = headers.join(",") + "\n" + row.join(",");
    const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
    const downloadAnchorNode = document.createElement('a');
    const fileName = `Result_${studentData.lname.replace(/[^a-z0-9]/gi, '')}_${studentData.fname.replace(/[^a-z0-9]/gi, '')}.csv`;
    
    document.getElementById('filename-display').innerText = fileName;
    
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", fileName);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// --- Teacher Flow ---

function toggleTeacherModal() {
    const modal = document.getElementById('password-modal');
    modal.classList.toggle('hidden');
    document.getElementById('pwd-error').classList.add('hidden');
    document.getElementById('teacher-pwd').value = "";
    if(!modal.classList.contains('hidden')) {
        setTimeout(() => document.getElementById('teacher-pwd').focus(), 100);
    }
}

function verifyTeacher() {
    const pwd = document.getElementById('teacher-pwd').value;
    if (pwd === TEACHER_PASSWORD) {
        toggleTeacherModal();
        document.getElementById('student-login').classList.add('hidden-section');
        document.getElementById('quiz-container').classList.add('hidden-section');
        document.getElementById('result-container').classList.add('hidden-section');
        document.getElementById('teacher-dashboard').classList.remove('hidden-section');
    } else {
        document.getElementById('pwd-error').classList.remove('hidden');
    }
}

function logoutTeacher() {
    location.reload();
}

window.toggleTeacherModal = toggleTeacherModal;
window.verifyTeacher = verifyTeacher;
window.logoutTeacher = logoutTeacher;

// --- Dashboard Logic ---

let classResults = [];

function handleDrop(e) {
    e.preventDefault();
    handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
    Array.from(files).forEach(file => {
        if (!file.name.toLowerCase().endsWith('.csv')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                if (lines.length < 2) return; 
                
                const rowStr = lines[1];
                const matches = rowStr.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                
                if (!matches || matches.length < 7) throw new Error("Invalid CSV");

                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/""/g, '"') : "";

                const res = {
                    name: clean(matches[0]),
                    period: clean(matches[1]),
                    score: parseInt(matches[2]),
                    rawScore: parseInt(matches[3]),
                    total: parseInt(matches[4]),
                    timestamp: clean(matches[5]),
                    missed: clean(matches[6]).split('|').filter(s => s !== "").map(Number)
                };

                if(!classResults.some(r => r.name === res.name && r.timestamp === res.timestamp)) {
                    classResults.push(res);
                }
                updateDashboard();
            } catch (err) {
                console.error("Error parsing file:", file.name, err);
            }
        };
        reader.readAsText(file);
    });
}

function updateDashboard() {
    const totalStudents = classResults.length;
    const avgScore = Math.round(classResults.reduce((acc, curr) => acc + curr.score, 0) / totalStudents) || 0;
    const highScore = Math.max(...classResults.map(r => r.score), 0);

    document.getElementById('stat-count').innerText = totalStudents;
    document.getElementById('stat-avg').innerText = avgScore + "%";
    document.getElementById('stat-high').innerText = highScore + "%";

    const tbody = document.getElementById('results-table-body');
    tbody.innerHTML = classResults.map(r => `
        <tr class="border-b hover:bg-gray-50 transition">
            <td class="p-3 font-medium text-gray-800">${r.name}</td>
            <td class="p-3 text-gray-500">${r.period}</td>
            <td class="p-3 font-bold ${getScoreColor(r.score)}">${r.score}%</td>
            <td class="p-3 text-xs text-gray-400 break-words max-w-xs">${formatMissed(r.missed)}</td>
        </tr>
    `).join('');

    const questionMissCounts = {};
    classResults.forEach(r => {
        r.missed.forEach(qIdx => {
            if (!isNaN(qIdx)) {
                questionMissCounts[qIdx] = (questionMissCounts[qIdx] || 0) + 1;
            }
        });
    });

    const sortedMissed = Object.keys(questionMissCounts)
        .map(key => ({ 
            index: parseInt(key), 
            count: questionMissCounts[key], 
            text: quizData[key].q 
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

    const missedContainer = document.getElementById('missed-questions-list');
    if (sortedMissed.length > 0) {
        missedContainer.innerHTML = sortedMissed.map(item => {
            const pct = Math.round((item.count / totalStudents) * 100);
            return `
                <div class="flex items-start bg-white p-3 rounded-lg border shadow-sm">
                    <span class="bg-red-100 text-red-800 font-bold px-2 py-1 rounded text-xs mr-3 mt-0.5">Q${item.index + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${item.text}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-red-500 h-2 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                        </div>
                        <p class="text-xs text-right text-red-600 mt-1 font-semibold">${pct}% of class missed this</p>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        missedContainer.innerHTML = `<p class="text-gray-500 italic text-center">No incorrect answers yet!</p>`;
    }
}

function formatMissed(missedArr) {
    if (!missedArr || missedArr.length === 0) return '<span class="text-green-500"><i class="fas fa-check"></i> Perfect</span>';
    return missedArr.map(i => i + 1).join(', ');
}

function getScoreColor(score) {
    if(score >= 90) return 'text-green-600';
    if(score >= 70) return 'text-yellow-600';
    return 'text-red-600';
}
</script>
</body>
</html>